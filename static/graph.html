<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>FastTrack | Metabolic Graph</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00f2fe;
            --secondary: #4facfe;
            --bg: #0a0a0c;
            --card-bg: rgba(255, 255, 255, 0.05);
            --text: #ffffff;
            --text-dim: rgba(255, 255, 255, 0.6);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: none;
            /* Crucial for custom gestures */
        }

        header {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .back-link {
            color: var(--text-dim);
            text-decoration: none;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
        }

        .logo {
            font-size: 1.1rem;
            font-weight: 700;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .refresh-btn {
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 8px 12px;
            border-radius: 10px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
        }

        .viewport {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #000;
            cursor: grab;
        }

        .viewport:active {
            cursor: grabbing;
        }

        #chart-img {
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: 0 0;
            will-change: transform;
            /* width and height will be set via script to maintain resolution */
        }

        .hud {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            padding: 10px 20px;
            border-radius: 30px;
            display: flex;
            gap: 20px;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hud span {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-dim);
        }
    </style>
</head>

<body>

    <header>
        <a href="/" class="back-link">‚Üê</a>
        <div class="logo">Metabolic Analytics (V28 Panzoom)</div>
        <div style="display: flex; gap: 10px;">
            <button class="refresh-btn" onclick="resetView()">Reset</button>
            <button class="refresh-btn" onclick="location.reload()">üîÑ</button>
        </div>
    </header>

    <main class="viewport" id="viewport">
        <img id="chart-img" src="/api/chart" alt="Metabolic Graph">
        <div class="hud">
            <span>Pinch to Zoom</span>
            <span>Drag to Pan</span>
        </div>
    </main>

    <script>
        const viewport = document.getElementById('viewport');
        const img = document.getElementById('chart-img');

        let scale = 1;
        let x = 0;
        let y = 0;
        let isDragging = false;
        let lastX, lastY;
        let lastDist = 0;

        // Initialize view
        img.onload = () => {
            resetView();
        };

        function resetView() {
            // Initial fit-to-width
            const vWidth = viewport.clientWidth;
            const iWidth = img.naturalWidth;

            scale = vWidth / iWidth;
            if (scale > 1) scale = 0.5; // Don't over-scale if small data

            x = 0;
            y = (viewport.clientHeight - (img.naturalHeight * scale)) / 2;
            updateTransform();
        }

        function updateTransform() {
            img.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
        }

        // Pointer Events (Mouse + Touch)
        viewport.addEventListener('pointerdown', e => {
            isDragging = true;
            lastX = e.clientX;
            lastY = e.clientY;
            viewport.setPointerCapture(e.pointerId);
        });

        viewport.addEventListener('pointermove', e => {
            if (!isDragging) return;

            // Pan logic
            const dx = e.clientX - lastX;
            const dy = e.clientY - lastY;

            x += dx;
            y += dy;

            lastX = e.clientX;
            lastY = e.clientY;

            updateTransform();
        });

        viewport.addEventListener('pointerup', e => {
            isDragging = false;
        });

        // Wheel (MacBook Trackpad Pinch + Scroll)
        // MacBook Trackpad pinch sends wheel event with ctrlKey: true
        viewport.addEventListener('wheel', e => {
            e.preventDefault();

            if (e.ctrlKey) {
                // Zoom
                const zoomFactor = 1 - e.deltaY * 0.01;
                const nextScale = scale * zoomFactor;

                // Keep zoom centered on mouse
                const rect = viewport.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                const imageMouseX = (mouseX - x) / scale;
                const imageMouseY = (mouseY - y) / scale;

                x = mouseX - imageMouseX * nextScale;
                y = mouseY - imageMouseY * nextScale;

                scale = nextScale;
            } else {
                // Scroll as Pan
                x -= e.deltaX;
                y -= e.deltaY;
            }

            updateTransform();
        }, { passive: false });

        // Touch Gestures (iPhone Pinch)
        viewport.addEventListener('touchstart', e => {
            if (e.touches.length === 2) {
                lastDist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
            }
        });

        viewport.addEventListener('touchmove', e => {
            if (e.touches.length === 2) {
                e.preventDefault();
                const dist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );

                const zoomFactor = dist / lastDist;
                const nextScale = scale * zoomFactor;

                // Zoom center (midpoint of fingers)
                const midX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                const midY = (e.touches[0].clientY + e.touches[1].clientY) / 2;

                const rect = viewport.getBoundingClientRect();
                const mouseX = midX - rect.left;
                const mouseY = midY - rect.top;

                const imageMouseX = (mouseX - x) / scale;
                const imageMouseY = (mouseY - y) / scale;

                x = mouseX - imageMouseX * nextScale;
                y = mouseY - imageMouseY * nextScale;

                scale = nextScale;
                lastDist = dist;
                updateTransform();
            }
        }, { passive: false });

    </script>
</body>

</html>